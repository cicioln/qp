{"version":3,"sources":["HTTP.js"],"names":["URL","exports","master_url","url","token","init","setURL","sendRequest","path","data","handler","extraUrl","xhr","cc","loader","getXMLHttpRequest","timeout","sendpath","sendtext","k","requestURL","encodeURI","console","log","open","sys","isNative","setRequestHeader","timer","setTimeout","hasRetried","abort","retryFunc","onreadystatechange","clearTimeout","readyState","status","responseURL","ret","respText","responseText","JSON","parse","e","errcode","errmsg","send"],"mappings":"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","file":"HTTP.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["\r\nvar URL = \"http://127.0.0.1:9000\";\r\n\r\nexports.master_url = null;\r\nexports.url = null;\r\nexports.token = null;\r\n\r\ninit();\r\n\r\nfunction init() {\r\n    exports.master_url = URL;\r\n    exports.url = URL;\r\n}\r\n\r\nfunction setURL(url) {\r\n    URL = url;\r\n    init();\r\n};\r\n\r\nfunction sendRequest(path, data, handler, extraUrl) {\r\n    var xhr = cc.loader.getXMLHttpRequest();\r\n    xhr.timeout = 5000;\r\n\r\n    if (data == null) {\r\n        data = {};\r\n    }\r\n    if (exports.token) {\r\n        data.token = exports.token;\r\n    }\r\n\r\n    if (extraUrl == null) {\r\n        extraUrl = exports.url;\r\n    }\r\n\r\n    //解析请求路由以及格式化请求参数\r\n    var sendpath = path;\r\n    var sendtext = '?';\r\n    for (var k in data) {\r\n        if (sendtext != \"?\") {\r\n            sendtext += \"&\";\r\n        }\r\n        sendtext += (k + \"=\" + data[k]);\r\n    }\r\n\r\n    //组装完整的URL\r\n    var requestURL = extraUrl + sendpath + encodeURI(sendtext);\r\n\r\n    //发送请求\r\n    console.log(\"RequestURL:\" + requestURL);\r\n    xhr.open(\"GET\", requestURL, true);\r\n\r\n    if (cc.sys.isNative) {\r\n        xhr.setRequestHeader(\"Accept-Encoding\", \"gzip,deflate\", \"text/html;charset=UTF-8\");\r\n    }\r\n\r\n    // 自定义请求超时重连方法\r\n    var timer = setTimeout(function() {\r\n        xhr.hasRetried = true;\r\n        xhr.abort(); // .abort() 方法用于中止当前的 XMLHttpRequest 请求  是XMLHttpRequestAPI中自带的\r\n        console.log('请求超时，正在重连...');\r\n        retryFunc();\r\n    }, 5000);\r\n\r\n    var retryFunc = function() {\r\n        sendRequest(path, data, handler, extraUrl);\r\n    };\r\n\r\n    xhr.onreadystatechange = function () {\r\n        console.log(\"onreadystatechange\");\r\n        clearTimeout(timer);\r\n        if (xhr.readyState === 4 && (xhr.status >= 200 && xhr.status < 300)) {\r\n            // console.log(\"http res(\" + xhr.responseText.length + \"):\" + xhr.responseText);\r\n            cc.log(\"request from [\" + xhr.responseURL + \"] data [\", ret, \"]\");\r\n            var respText = xhr.responseText;\r\n\r\n            var ret = null;\r\n            try {\r\n                ret = JSON.parse(respText);\r\n            } catch (e) {\r\n                console.log(\"err:\" + e);\r\n                ret = {\r\n                    errcode: -10001,\r\n                    errmsg: e\r\n                };\r\n            }\r\n\r\n            if (handler) {\r\n                handler(ret);\r\n            }\r\n\r\n            handler = null;\r\n        }\r\n        else if (xhr.readyState === 4) {\r\n            if(xhr.hasRetried){\r\n                return;\r\n            }\r\n\r\n            console.log('other readystate == 4' + ', status:' + xhr.status);\r\n            setTimeout(function() {\r\n                retryFunc();\r\n            }, 5000);\r\n        }\r\n        else {\r\n            console.log('other readystate:' + xhr.readyState + ', status:' + xhr.status);\r\n        }\r\n    };\r\n\r\n    try {\r\n        xhr.send();\r\n    }\r\n    catch (e) {\r\n        //setTimeout(retryFunc, 200);\r\n        retryFunc();\r\n    }\r\n\r\n    return xhr;\r\n}\r\n\r\nexports.sendRequest = sendRequest;\r\nexports.setURL = setURL;\r\n"]}